<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Screenshot Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            max-width: 90%;
            width: 700px;
        }
    </style>
</head>
<body>
    <div class="container bg-white p-8 rounded-xl shadow-2xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">Payment Screenshot Analyzer</h1>
        <p class="text-gray-600 mb-6">Upload an image of a payment receipt/screenshot for structured data extraction using the Gemini API.</p>

        <!-- Upload Form -->
        <form id="uploadForm" class="space-y-4">
            <div>
                <label for="fileInput" class="block text-sm font-medium text-gray-700 mb-1">Select Screenshot:</label>
                <input type="file" id="fileInput" name="file" accept="image/*" required 
                       class="w-full text-sm text-gray-500
                              file:mr-4 file:py-2 file:px-4
                              file:rounded-full file:border-0
                              file:text-sm file:font-semibold
                              file:bg-indigo-50 file:text-indigo-700
                              hover:file:bg-indigo-100 transition duration-150 ease-in-out"/>
            </div>
            <button type="submit" id="submitButton"
                    class="w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md
                           hover:bg-indigo-700 transition duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                Analyze Image
            </button>
        </form>

        <!-- Status and Result Display -->
        <div id="statusMessage" class="mt-6 p-3 rounded-lg text-center font-medium hidden"></div>
        <div id="resultContainer" class="mt-6 p-6 bg-gray-50 border border-gray-200 rounded-xl hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-3">Analysis Result (JSON)</h2>
            <pre id="jsonResult" class="bg-gray-800 text-green-300 p-4 rounded-lg overflow-x-auto text-sm"></pre>
        </div>
    </div>

    <script>
        const uploadForm = document.getElementById('uploadForm');
        const fileInput = document.getElementById('fileInput');
        const submitButton = document.getElementById('submitButton');
        const statusMessage = document.getElementById('statusMessage');
        const resultContainer = document.getElementById('resultContainer');
        const jsonResult = document.getElementById('jsonResult');

        function setStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `mt-6 p-3 rounded-lg text-center font-medium`;
            statusMessage.classList.remove('hidden');

            if (type === 'success') {
                statusMessage.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                statusMessage.classList.add('bg-red-100', 'text-red-800');
            } else { // info/loading
                statusMessage.classList.add('bg-blue-100', 'text-blue-800');
            }
        }

        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!fileInput.files.length) {
                setStatus('Please select a file first.', 'error');
                return;
            }

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);

            // UI state: loading
            submitButton.disabled = true;
            submitButton.textContent = 'Analyzing... Please wait.';
            resultContainer.classList.add('hidden');
            setStatus('Uploading and analyzing image. This may take a moment...', 'info');

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    // Success or structured failure from model
                    jsonResult.textContent = JSON.stringify(result, null, 2);
                    resultContainer.classList.remove('hidden');
                    
                    const status = result.is_payment_screenshot ? 'SUCCESS' : 'FAILURE';
                    const reason = result.error_reason !== 'N/A' ? result.error_reason : 'All compulsory fields found!';
                    
                    const messageType = result.is_payment_screenshot ? 'success' : 'error';
                    setStatus(`Analysis Complete. Status: ${status}. Reason: ${reason}`, messageType);

                } else {
                    // Flask backend errors (400, 500)
                    const errorMsg = result.message || 'An unknown error occurred on the server.';
                    setStatus(`API Error: ${errorMsg}`, 'error');
                    jsonResult.textContent = JSON.stringify(result, null, 2);
                    resultContainer.classList.remove('hidden');
                }

            } catch (error) {
                console.error('Fetch error:', error);
                setStatus('Network error or server connection failed.', 'error');
            } finally {
                // UI state: done
                submitButton.disabled = false;
                submitButton.textContent = 'Analyze Image';
            }
        });
    </script>
</body>
</html>
